import os
import asyncio
import json
from openai import AzureOpenAI
from django.conf import settings
from typing import AsyncGenerator, Dict, Any
import logging

logger = logging.getLogger(__name__)

class AplyflyChatAgent:
    """
    Agente de IA especializado para Aplyfly - Asistente de atenci√≥n al cliente
    100% enfocado en desarrollo de software y servicios de Aplyfly
    """
    
    def __init__(self):
        # Configuraci√≥n temporal sin Azure - usaremos respuestas predefinidas
        self.deployment = "gpt-4"
        
        # Personalidad y conocimiento de Aplyfly
        self.system_prompt = """
        Eres AplyBot, asistente virtual de Aplyfly - empresa l√≠der en desarrollo de software.
        
        IDENTIDAD:
        - Personalidad: Profesional, t√©cnico pero amigable
        - Objetivo: Convertir consultas en leads calificados
        
        SERVICIOS DE APLYFLY:
        
        üöÄ PRINCIPALES:
        1. **Apps Web**: React, Vue.js, Django, PWAs escalables
        2. **Sistemas Empresariales**: CRM, ERP, automatizaci√≥n, APIs
        3. **Inteligencia Artificial**: GPT, Claude, chatbots, ML
        4. **Apps M√≥viles**: React Native, Flutter, nativas iOS/Android
        5. **APIs & Microservicios**: REST, GraphQL, Docker, Kubernetes
        6. **Consultor√≠a**: Auditor√≠as, arquitectura, migraci√≥n cloud
        
        üè¢ EMPRESA:
        - +100 proyectos exitosos
        - 99% satisfacci√≥n
        - Equipo senior
        - Metodolog√≠a √°gil
        - Soporte 24/7
        
        üíº PROCESO:
        1. Consulta gratuita 30min
        2. Propuesta t√©cnica personalizada
        3. Desarrollo √°gil iterativo
        4. Testing y deploy
        5. Soporte continuo
        
        üìû CONTACTO:
        - Email: info@aplyfly.com
        - WhatsApp: +123 456 7890
        - Consulta gratuita disponible
        
        INSTRUCCIONES:
        
        1. **Respuestas CONCISAS** - m√°ximo 3-4 l√≠neas
        2. **Identifica necesidades** con preguntas espec√≠ficas
        3. **Relaciona con servicios** de Aplyfly
        4. **Dirige a consulta gratuita** como siguiente paso
        5. **Usa emojis moderadamente**
        6. **Mant√©n tono profesional pero cercano**
        
        RESPUESTAS TIPO:
        - IA: "¬°Perfecto! Especialistas en IA. Hemos implementado chatbots y ML con OpenAI/Claude. ¬øQu√© tipo de automatizaci√≥n necesitas?"
        - Apps m√≥viles: "Desarrollamos apps nativas y multiplataforma con React Native/Flutter. ¬øPara qu√© plataformas y qu√© funcionalidad principal?"
        - Precios: "Depende del alcance. Ofrezco consulta gratuita de 30min para analizar tu proyecto. ¬øCu√°ndo te viene bien?"
        
        ¬°IMPORTANTE: Respuestas cortas, directas y siempre con pregunta para continuar conversaci√≥n!
        
        NUNCA menciones competencia. Posiciona Aplyfly como mejor opci√≥n.
        """
        
        # Respuestas predefinidas inteligentes
        self.predefined_responses = {
            'saludo': [
                "¬°Hola! üëã Soy AplyBot de Aplyfly. Especialistas en desarrollo web, IA y apps m√≥viles. ¬øEn qu√© proyecto puedo ayudarte? üöÄ",
                "¬°Bienvenido/a! Soy tu asistente virtual de Aplyfly. ¬øTienes alg√∫n proyecto de desarrollo en mente? üíª",
            ],
            'servicios': [
                "Ofrecemos: Apps Web (React/Django), IA & Chatbots, Apps M√≥viles, APIs, y Consultor√≠a. ¬øQu√© tipo de proyecto tienes en mente? üõ†Ô∏è",
                "Nuestros servicios principales: Desarrollo Web, Inteligencia Artificial, Apps M√≥viles, Sistemas Empresariales. ¬øCu√°l te interesa m√°s? üí°",
            ],
            'web': [
                "¬°Perfecto! Desarrollamos apps web modernas con React, Vue.js y Django. PWAs, sistemas escalables. ¬øQu√© funcionalidad necesitas? üåê",
                "Especialistas en desarrollo web: React, Vue, Django, APIs. ¬øTu proyecto es e-commerce, dashboard, o qu√© tipo de aplicaci√≥n? üíª",
            ],
            'ia': [
                "¬°Excelente! Implementamos IA: chatbots inteligentes, an√°lisis de datos, automatizaci√≥n con OpenAI/Claude. ¬øQu√© quieres automatizar? ü§ñ",
                "Servicios de IA: Chatbots, ML, an√°lisis de datos, integraci√≥n GPT. ¬øPara qu√© industria o caso espec√≠fico? üß†",
            ],
            'movil': [
                "Desarrollamos apps nativas y multiplataforma con React Native/Flutter. iOS, Android. ¬øQu√© tipo de app necesitas? üì±",
                "Apps m√≥viles nativas y cross-platform. React Native, Flutter. ¬øEs para iOS, Android o ambas? ¬øQu√© funcionalidad? üöÄ",
            ],
            'precio': [
                "Los precios dependen del alcance y complejidad. Ofrezco consulta gratuita de 30min para analizar tu proyecto. ¬øTe parece bien? üí∞",
                "Cada proyecto es √∫nico. ¬øTe gustar√≠a una consulta gratuita para evaluar tu idea y darte un presupuesto personalizado? üìä",
            ],
            'contacto': [
                "¬°Perfecto! Puedes contactarnos: info@aplyfly.com o WhatsApp +123 456 7890. ¬øPrefieres una llamada o empezamos por email? üìû",
                "Contacto directo: info@aplyfly.com. Tambi√©n ofrezco consulta gratuita de 30min. ¬øCu√°ndo te viene bien? ‚è∞",
            ],
            'default': [
                "Interesante proyecto. En Aplyfly manejamos desarrollo web, IA, apps m√≥viles y m√°s. ¬øPodr√≠as contarme m√°s detalles? ü§î",
                "¬°Genial! Somos especialistas en soluciones tech personalizadas. ¬øQu√© tecnolog√≠a o funcionalidad espec√≠fica necesitas? üí°",
            ]
        }
    
    async def get_chat_response(self, message: str, conversation_history: list = None) -> AsyncGenerator[str, None]:
        """
        Genera respuesta streaming del agente de IA usando respuestas inteligentes
        """
        try:
            # Analizar el mensaje para dar respuesta contextual
            response = self._get_smart_response(message.lower())
            
            # Simular streaming palabra por palabra
            words = response.split(' ')
            for i, word in enumerate(words):
                if i == 0:
                    yield word
                else:
                    yield f" {word}"
                await asyncio.sleep(0.05)  # Simular delay natural
                    
        except Exception as e:
            logger.error(f"Error en chat agent: {str(e)}")
            yield f"Disculpa, hubo un error t√©cnico. Por favor contacta directamente a info@aplyfly.com o intenta nuevamente. üîß"
    
    def get_response_sync(self, message: str, conversation_history: list = None) -> str:
        """
        Versi√≥n s√≠ncrona para casos donde no se necesita streaming
        """
        try:
            # Analizar contexto del historial
            context = self._analyze_conversation_context(conversation_history or [])
            return self._get_smart_response(message.lower(), context)
            
        except Exception as e:
            logger.error(f"Error en chat agent sync: {str(e)}")
            return "Disculpa, hubo un error t√©cnico. Por favor contacta directamente a info@aplyfly.com üîß"
    
    def _analyze_conversation_context(self, history: list) -> dict:
        """
        Analiza el historial de conversaci√≥n para extraer contexto
        """
        context = {
            'user_name': None,
            'topics_discussed': [],
            'services_mentioned': []
        }
        
        # Buscar nombre del usuario en mensajes anteriores
        for msg in history:
            if isinstance(msg, dict) and msg.get('role') == 'user':
                content = msg.get('content', '').lower()
                print(f"üîç Analizando mensaje del usuario: {content}")
                
                # Detectar presentaci√≥n del usuario - patrones m√°s amplios
                if any(phrase in content for phrase in ['me llamo', 'soy', 'mi nombre es', 'soy pedro', 'soy juan']):
                    words = content.split()
                    for i, word in enumerate(words):
                        if word in ['llamo', 'soy', 'nombre'] and i + 1 < len(words):
                            # Tomar la siguiente palabra como nombre
                            potential_name = words[i + 1].capitalize()
                            # Si hay dos palabras despu√©s (nombre y apellido)
                            if i + 2 < len(words) and words[i + 2].replace(',', '').isalpha():
                                context['user_name'] = f"{potential_name} {words[i + 2].capitalize()}"
                            else:
                                context['user_name'] = potential_name
                            print(f"üë§ Nombre detectado: {context['user_name']}")
                            break
                
                # Tambi√©n detectar si dice directamente su nombre
                # Buscar nombres comunes en el texto
                common_names = ['pedro', 'juan', 'maria', 'ana', 'carlos', 'luis', 'jose', 'antonio', 'francisco', 'manuel', 'david', 'daniel', 'rafael', 'miguel', 'alejandro', 'gonzalez', 'rodriguez', 'garcia', 'martinez', 'lopez', 'hernandez', 'perez', 'sanchez', 'ramirez', 'cruz']
                for name in common_names:
                    if name in content and not context['user_name']:
                        # Buscar el contexto alrededor del nombre
                        words = content.split()
                        for i, word in enumerate(words):
                            if name in word.lower():
                                if i + 1 < len(words) and words[i + 1].replace(',', '').isalpha():
                                    context['user_name'] = f"{word.capitalize()} {words[i + 1].capitalize()}"
                                else:
                                    context['user_name'] = word.capitalize()
                                print(f"üë§ Nombre detectado por patr√≥n: {context['user_name']}")
                                break
                
                # Detectar temas mencionados
                if any(word in content for word in ['web', 'p√°gina', 'sitio']):
                    context['topics_discussed'].append('web')
                if any(word in content for word in ['ia', 'inteligencia', 'ai']):
                    context['topics_discussed'].append('ia')
                if any(word in content for word in ['m√≥vil', 'app', 'aplicaci√≥n']):
                    context['topics_discussed'].append('mobile')
        
        print(f"üìä Contexto final: {context}")
        return context
    
    def _get_smart_response(self, message: str, context: dict = None) -> str:
        """
        Analiza el mensaje y devuelve una respuesta contextual inteligente
        """
        import random
        
        if context is None:
            context = {}
        
        message = message.lower().strip()
        user_name = context.get('user_name', '')
        
        # Respuestas personalizadas si conocemos el nombre
        name_prefix = f"¬°Hola {user_name}! " if user_name else ""
        
        # Detectar preguntas espec√≠ficas sobre contexto
        if any(phrase in message for phrase in ['mi nombre', 'c√≥mo me llamo', 'cual es mi nombre', 'como me llamo']):
            if user_name:
                return f"Te llamas {user_name}, ¬øverdad? üòä ¬øEn qu√© proyecto puedo ayudarte?"
            else:
                return "No me has dicho tu nombre a√∫n. ¬øC√≥mo te llamas? üòä"
        
        # Detectar cuando el usuario se presenta (nombres espec√≠ficos)
        if any(name in message for name in ['pedro', 'juan', 'maria', 'ana', 'carlos', 'luis']):
            if 'pedro' in message and 'gonzalez' in message:
                return "¬°Mucho gusto Pedro Gonz√°lez! üòä ¬øEn qu√© proyecto puedo ayudarte hoy?"
            elif any(phrase in message for phrase in ['me llamo', 'soy']):
                # Extraer el nombre del mensaje actual
                words = message.split()
                for i, word in enumerate(words):
                    if word in ['llamo', 'soy'] and i + 1 < len(words):
                        name_parts = []
                        # Recoger palabras que parecen nombres
                        for j in range(i + 1, min(i + 3, len(words))):
                            if words[j].replace(',', '').replace('.', '').isalpha():
                                name_parts.append(words[j].capitalize())
                        if name_parts:
                            full_name = ' '.join(name_parts)
                            return f"¬°Mucho gusto {full_name}! üòä ¬øEn qu√© proyecto puedo ayudarte hoy?"
        
        # Detectar intenci√≥n basada en palabras clave
        if any(word in message for word in ['hola', 'hello', 'hi', 'buenas', 'buenos']):
            response = random.choice(self.predefined_responses['saludo'])
            return name_prefix + response if user_name else response
        
        elif any(word in message for word in ['servicio', 'qu√© hacen', 'qu√© ofrecen', 'servicios', 'capaz', 'haces']):
            responses = [
                "üöÄ **Servicios Aplyfly:**\n‚Ä¢ Apps Web (React/Django)\n‚Ä¢ IA & Chatbots\n‚Ä¢ Apps M√≥viles\n‚Ä¢ APIs & Sistemas\n\n¬øQu√© tipo de proyecto tienes en mente?",
                "Somos especialistas en:\n‚úÖ Desarrollo Web moderno\n‚úÖ Inteligencia Artificial\n‚úÖ Apps M√≥viles nativas\n‚úÖ Sistemas empresariales\n\n¬øCu√°l te interesa m√°s? üí°"
            ]
            return random.choice(responses)
        
        elif any(word in message for word in ['web', 'p√°gina', 'sitio', 'react', 'django', 'frontend']):
            return random.choice(self.predefined_responses['web'])
        
        elif any(word in message for word in ['ia', 'inteligencia artificial', 'chatbot', 'bot', 'ai', 'machine learning', 'ml', 'proyecto ia', 'quiero un proyecto ia']):
            responses = [
                "¬°Perfecto para IA! ü§ñ Implementamos:\n‚Ä¢ Chatbots inteligentes\n‚Ä¢ An√°lisis de datos con ML\n‚Ä¢ Automatizaci√≥n con GPT/Claude\n‚Ä¢ Asistentes virtuales\n\n¬øPara qu√© industria o proceso espec√≠fico?",
                "¬°Excelente elecci√≥n! IA es nuestro fuerte:\n‚úÖ Chatbots conversacionales\n‚úÖ An√°lisis predictivo\n‚úÖ Automatizaci√≥n inteligente\n‚úÖ Integraci√≥n OpenAI/Claude\n\n¬øQu√© quieres automatizar? üß†"
            ]
            return random.choice(responses)
        
        elif any(word in message for word in ['m√≥vil', 'movil', 'app', 'aplicaci√≥n', 'ios', 'android', 'flutter', 'react native']):
            return random.choice(self.predefined_responses['movil'])
        
        elif any(word in message for word in ['precio', 'costo', 'cu√°nto', 'presupuesto', 'cotizaci√≥n', 'vale', 'costar']):
            return random.choice(self.predefined_responses['precio'])
        
        elif any(word in message for word in ['contacto', 'contactar', 'llamar', 'email', 'whatsapp']):
            return random.choice(self.predefined_responses['contacto'])
        
        elif any(phrase in message for phrase in ['recomienda', 'recomendaci√≥n', 'consejo', 'sugieres', 'lo que me recomiendes']):
            if context.get('topics_discussed'):
                topics = context['topics_discussed']
                if 'ia' in topics:
                    return f"Para IA {name_prefix}te recomiendo empezar con un chatbot inteligente para tu web. ¬øQu√© industria es tu negocio? ü§ñ"
                elif 'web' in topics:
                    return f"Para web {name_prefix}recomiendo React + Django para m√°ximo rendimiento. ¬øQu√© funcionalidades necesitas? üíª"
            
            # Recomendaci√≥n general personalizada
            if user_name:
                return f"¬°Perfecto {user_name}! Te recomiendo empezar con una consulta gratuita de 30min para entender mejor tu proyecto. Seg√∫n lo que me cuentes, podemos sugerir la mejor tecnolog√≠a. ¬øTe parece bien? üí°"
            else:
                return "Te recomiendo empezar con una consulta gratuita para evaluar tu proyecto espec√≠fico. ¬øCu√°l es tu industria o tipo de negocio? üí°"
        
        else:
            # Respuesta por defecto m√°s inteligente
            if user_name:
                return f"Entiendo {user_name}. En Aplyfly manejamos desarrollo web, IA, apps m√≥viles y sistemas empresariales. ¬øPodr√≠as contarme m√°s detalles sobre lo que necesitas? ü§î"
            else:
                return random.choice(self.predefined_responses['default'])

# Instancia global del agente
aplyfly_agent = AplyflyChatAgent()
